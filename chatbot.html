<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Assistente Kah Siqueira</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Importa√ß√£o de fonte do Google Fonts (Montserrat) */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap');

        /* Estilos Globais e Reset B√°sico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Garante que padding e border n√£o aumentem o tamanho do elemento */
        }

        /* Removendo estilos de body que duplicam o layout do site principal */
        body {
            font-family: 'Montserrat', sans-serif; /* Aplica a fonte da cliente */
            background-color: transparent; /* Fundo transparente para o iframe */
            color: #513F32; /* Cor de texto principal da cliente */
            /* Removendo display: flex, justify-content, align-items, min-height para evitar dupla centraliza√ß√£o */
            display: block; /* Volta ao comportamento padr√£o de bloco */
            height: 100%; /* Ocupa 100% da altura dispon√≠vel no iframe */
            width: 100%; /* Ocupa 100% da largura dispon√≠vel no iframe */
            overflow: hidden; /* Evita barras de rolagem indesejadas no body do iframe */
        }

        /* Container Principal do Chat - Ajustado para preencher o iframe */
        .chat-container {
            background-color: #ffffff; /* Fundo branco do chat, ser√° vis√≠vel dentro do iframe */
            border-radius: 0; /* Remove cantos arredondados, pois o iframe j√° tem */
            box-shadow: none; /* Remove sombra, pois o site principal pode ter a sua */
            width: 100%; /* Ocupa 100% da largura do body do iframe */
            height: 100%; /* Ocupa 100% da altura do body do iframe */
            display: flex;
            flex-direction: column; /* Organiza os elementos internos em coluna */
            overflow: hidden; /* Garante que nada transborde */
            max-width: none; /* Remove o max-width fixo */
            max-height: none; /* Remove o max-height fixo */
        }

        /* Cabe√ßalho do Chat */
        .chat-header {
            background-color: #997D6C; /* brand-primary da cliente */
            padding: 15px;
            display: flex;
            justify-content: space-between; /* Alinha itens nas extremidades */
            align-items: center;
            color: #ffffff; /* Cor do texto branco */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* Linha divis√≥ria sutil */
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px; /* Espa√ßamento entre os itens */
        }

        .chat-header-left .avatar { /* Estilo para o avatar no cabe√ßalho */
            width: 40px;
            height: 40px;
            border-radius: 50%; /* Torna a imagem redonda */
            object-fit: cover; /* Garante que a imagem preencha o espa√ßo sem distor√ß√£o */
        }

        .chat-info .chat-name { /* Nome do chat no cabe√ßalho */
            font-weight: 700; /* Negrito para o nome, da fonte Montserrat */
            font-size: 1.1em;
        }

        .chat-header button { /* Bot√µes no cabe√ßalho (ex: configura√ß√µes, fechar) */
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s; /* Transi√ß√£o suave para hover */
        }

        .chat-header button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* √Årea de Mensagens */
        #chat-messages { /* Mant√©m o ID existente no chatbot.html */
            flex-grow: 1; /* Ocupa o espa√ßo restante verticalmente */
            padding: 15px;
            overflow-y: auto; /* Adiciona barra de rolagem se o conte√∫do for maior */
            display: flex;
            flex-direction: column; /* Mensagens se empilham verticalmente */
            gap: 10px; /* Espa√ßamento entre as mensagens */
            background-color: #ffffff; /* Fundo branco da √°rea de mensagens */
        }

        /* Estilo para a barra de rolagem (WebKit - Chrome, Edge, Safari) */
        #chat-messages::-webkit-scrollbar {
            width: 8px; /* Largura da barra de rolagem */
        }

        #chat-messages::-webkit-scrollbar-track {
            background: #E6E0D9; /* brand-bg-light da cliente */
            border-radius: 10px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #997D6C; /* brand-primary da cliente */
            border-radius: 10px;
            border: 2px solid #E6E0D9; /* Borda da al√ßa */
        }

        /* Campo de Entrada de Mensagem */
        #input-area { /* Mant√©m o ID existente no chatbot.html */
            display: flex;
            padding: 15px;
            background-color: #ffffff; /* Fundo branco da √°rea de input */
            border-top: 1px solid #E6E0D9; /* Linha divis√≥ria da cliente */
            gap: 10px; /* Espa√ßamento entre o input e o bot√£o */
        }

        #user-input { /* Mant√©m o ID existente no chatbot.html */
            flex-grow: 1; /* Ocupa o m√°ximo de largura poss√≠vel */
            padding: 12px 15px;
            border: 1px solid #D1C8BF; /* Borda levemente escura da cliente */
            border-radius: 25px; /* Cantos bem arredondados, do seu design */
            background-color: #F8F5F1; /* Fundo do campo de input, cor clara */
            color: #513F32; /* Cor do texto digitado da cliente */
            font-size: 0.95em; /* Tamanho da fonte do cliente */
            outline: none; /* Remove a borda de foco padr√£o */
            font-family: 'Montserrat', sans-serif; /* Fonte da cliente */
        }

        #user-input::placeholder {
            color: #9E8F7D; /* Cor do texto de placeholder da cliente */
        }

        #send-button { /* Mant√©m o ID existente no chatbot.html */
            background-color: #513F32; /* brand-accent da cliente */
            color: white;
            border: none;
            border-radius: 50%; /* Bot√£o redondo, do seu design */
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-family: 'Montserrat', sans-serif; /* Fonte da cliente */
            font-weight: 500;
            font-size: 0.95em;
        }

        #send-button:hover {
            background-color: #413228; /* Cor mais escura no hover da cliente */
        }

        #send-button:disabled {
            background-color: #9E8F7D; /* Cor desabilitada da cliente */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* √çcone de seta SVG para o bot√£o de enviar */
        #send-button svg {
            width: 20px;
            height: 20px;
            fill: #ffffff; /* Cor do √≠cone branco */
            transform: rotate(0deg); /* Rotaciona a seta para cima */
            margin-top: -3px; /* Ajuste fino para posicionar a seta */
            margin-left: 3px;
        }

        /* Responsividade B√°sica (para telas menores que 400px) - Mantenha este media query se o chat for usado em um modal responsivo */
        @media (max-width: 400px) {
            .chat-container {
                border-radius: 0; /* Remove cantos arredondados em telas muito pequenas */
                height: 100%; /* Ocupa 100% da altura do iframe */
                max-width: 100%; /* Ocupa 100% da largura do iframe */
            }
        }

        /* Estilos para Mensagens do Chat */
        .message { /* Container flex para avatar e bal√£o de texto */
            display: flex;
            align-items: flex-start; /* Alinha o avatar e o bal√£o no topo */
            max-width: 85%; /* Limita a largura do bal√£o */
            margin-bottom: 10px; /* Espa√ßamento entre mensagens */
        }

        .message-avatar { /* Estilo para o avatar dentro da mensagem */
            width: 32px; /* Tamanho do avatar dentro da mensagem */
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0; /* Evita que o avatar encolha */
            margin-top: 5px; /* Pequeno ajuste para alinhar com o texto */
        }

        .message-content { /* Container para o nome e o bal√£o de texto */
            display: flex;
            flex-direction: column;
            margin-left: 8px; /* Espa√ßo entre avatar e bal√£o */
        }

        .message-content strong { /* Estilo para o nome do remetente dentro da mensagem */
            display: block;
            margin-bottom: 2px; /* Espa√ßo entre nome e texto */
            font-size: 0.8em;
            font-weight: 700;
            opacity: 0.8;
        }

        .text-bubble { /* Estilo para o bal√£o de texto da mensagem */
            padding: 10px 14px; /* Padding do bubble */
            border-radius: 18px; /* Cantos arredondados do bubble */
            word-wrap: break-word; /* Quebra palavras longas */
            line-height: 1.5; /* Espa√ßamento entre linhas */
            font-size: 0.95em; /* Tamanho da fonte do cliente */
        }

        /* Estilo para Mensagens da IA (K.A.S.I.) */
        .ai-message {
            align-self: flex-start; /* Alinha √† esquerda no flex container */
        }

        .ai-message .message-avatar {
            margin-right: 0; /* Remove margem direita para avatar da IA */
        }

        .ai-message .message-content {
            margin-left: 8px; /* Espa√ßo entre avatar e bal√£o da IA */
        }

        .ai-message .text-bubble {
            background-color: #E6E0D9; /* brand-bg-light da cliente para mensagens da IA */
            color: #513F32; /* brand-text da cliente */
            border-bottom-left-radius: 4px; /* Canto inferior esquerdo menos arredondado */
        }

        /* Estilo para Mensagens do Usu√°rio */
        .user-message {
            align-self: flex-end; /* Alinha √† direita no flex container */
            flex-direction: row-reverse; /* Inverte a ordem para bal√£o √† direita */
        }

        .user-message .message-avatar {
            margin-left: 8px; /* Espa√ßo entre avatar e bal√£o para mensagens do usu√°rio */
            margin-right: 0; /* Remove margem direita para avatar do usu√°rio */
        }

        .user-message .message-content {
            margin-right: 8px; /* Espa√ßo entre avatar e bal√£o do usu√°rio */
            margin-left: 0;
            align-items: flex-end; /* Alinha o nome e o bal√£o √† direita */
        }

        .user-message .text-bubble {
            background-color: #997D6C; /* brand-primary da cliente para mensagens do usu√°rio */
            color: #ffffff; /* Texto branco para contraste */
            border-bottom-right-radius: 4px; /* Canto inferior direito menos arredondado */
        }

        .user-message .message-content strong {
            color: rgba(255, 255, 255, 0.8); /* Cor do nome do remetente para mensagens do usu√°rio */
        }

        /* Estilo para o Indicador de Digita√ß√£o (Typing Indicator) */
        .message.typing-indicator { /* Aplica-se ao div.message quando √© um indicador de digita√ß√£o */
            background-color: transparent; /* Fundo transparente para o indicador */
            box-shadow: none;
            padding: 0; /* Remove padding do bubble */
            margin-bottom: 10px;
            align-self: flex-start; /* Alinha √† esquerda */
            display: flex; /* Para alinhar as bolinhas */
            justify-content: flex-start;
            align-items: center;
            width: auto; /* Largura autom√°tica */
            min-height: 30px; /* Altura m√≠nima para as bolinhas */
        }

        .message.typing-indicator .message-content {
            flex-direction: row; /* Alinha as bolinhas horizontalmente */
            align-items: center;
            margin-left: 8px; /* Espa√ßo entre avatar e bolinhas */
        }

        .message.typing-indicator strong {
            display: none; /* Esconde o nome do remetente para o indicador de digita√ß√£o */
        }

        /* Anima√ß√£o das Bolinhas */
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #997D6C; /* Cor das bolinhas da cliente */
            color: #997D6C;
            animation: dotFlashing 1s infinite alternate; /* Anima√ß√£o principal */
            animation-delay: 0s;
            margin: 0 2px; /* Espa√ßamento entre as bolinhas */
        }

        .dot-flashing::before,
        .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #997D6C;
            color: #997D6C;
            animation: dotFlashing 1s infinite alternate;
        }

        .dot-flashing::before {
            left: -12px; /* Posi√ß√£o da bolinha da esquerda */
            animation-delay: 0.2s; /* Atraso na anima√ß√£o */
        }

        .dot-flashing::after {
            left: 12px; /* Posi√ß√£o da bolinha da direita */
            animation-delay: 0.4s; /* Atraso na anima√ß√£o */
        }

        @keyframes dotFlashing {
            0% {
                background-color: #997D6C;
            }
            50%,
            100% {
                background-color: #513F32; /* Cor mais escura na anima√ß√£o */
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-left">
                <button aria-label="Voltar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
                        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
                    </svg>
                </button>
                <img src="imagens/kah/kasi.png" onerror="this.onerror=null;this.src='https://placehold.co/40x40/997D6C/ffffff?text=K'" alt="Avatar K.A.S.I." class="avatar">
                <div class="chat-info">
                    <div class="chat-name">K.A.S.I. Assistente</div>
                </div>
            </div>
            <button aria-label="Op√ß√µes">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </button>
        </div>

        <div id="chat-messages">
            </div>

        <div id="input-area">
            <input type="text" id="user-input" placeholder="Escreva sua mensagem...">
            <button id="send-button" aria-label="Enviar mensagem">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <script type="module">
        const NOME_DA_ASSISTENTE = "K.A.S.I.";
        const ARQUIVO_INSTRUCOES = 'instrucao-kasi.md';
        let systemInstructionContent = '';
        let isChatReady = false;

        const chatMessagesDiv = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let clientChatHistory = [];

        const saudacaoInicialKASI = `Ol√°! üòä Sou K.A.S.I., assistente virtual da Kah Siqueira. Qual √© a sua d√∫vida?`;

        function addMessageToChat(sender, message, isUser) {
            if (!chatMessagesDiv) return;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isUser ? 'user-message' : 'ai-message');

            const avatarImg = document.createElement('img');
            avatarImg.classList.add('message-avatar');
            if (isUser) {
                avatarImg.src = 'https://placehold.co/32x32/D1C8BF/513F32?text=V';
                avatarImg.alt = 'Avatar do Usu√°rio';
            } else {
                avatarImg.src = 'imagens/kah/kasi.png';
                avatarImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/32x32/997D6C/ffffff?text=K'; };
                avatarImg.alt = 'Avatar K.A.S.I.';
            }
            messageDiv.appendChild(avatarImg);

            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('message-content');

            const senderStrong = document.createElement('strong');
            senderStrong.textContent = sender;
            messageContentDiv.appendChild(senderStrong);

            const textBubbleDiv = document.createElement('div');
            textBubbleDiv.classList.add('text-bubble');

            let formattedMessage = message.replace(/\n/g, '<br>');
            formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            const messageText = document.createElement('p');
            messageText.innerHTML = formattedMessage;
            textBubbleDiv.appendChild(messageText);

            messageContentDiv.appendChild(textBubbleDiv);
            messageDiv.appendChild(messageContentDiv);

            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function showLoadingIndicator() {
            if (!chatMessagesDiv) return;
            const existingLoadingDiv = document.getElementById('loading');
            if (existingLoadingDiv) existingLoadingDiv.remove();

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'ai-message', 'typing-indicator');
            messageDiv.id = 'loading';

            const avatarImg = document.createElement('img');
            avatarImg.classList.add('message-avatar');
            avatarImg.src = 'imagens/kah/kasi.png';
            avatarImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/32x32/997D6C/ffffff?text=K'; };
            avatarImg.alt = 'Avatar K.A.S.I.';
            messageDiv.appendChild(avatarImg);

            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('message-content');

            const dotFlashingDiv = document.createElement('div');
            dotFlashingDiv.classList.add('dot-flashing');

            messageContentDiv.appendChild(dotFlashingDiv);
            messageDiv.appendChild(messageContentDiv);

            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) loadingDiv.remove();
        }

        async function carregarInstrucoes() {
            try {
                const response = await fetch(ARQUIVO_INSTRUCOES);
                if (!response.ok) {
                    console.error(`Erro ao carregar o arquivo de instru√ß√µes: ${response.statusText} (status: ${response.status}). Verifique o caminho: ${ARQUIVO_INSTRUCOES}`);
                    throw new Error(`Erro ao carregar o arquivo de instru√ß√µes: ${response.statusText} (status: ${response.status})`);
                }
                systemInstructionContent = await response.text();
                console.log("Instru√ß√µes da IA carregadas com sucesso.");
                console.log("Conte√∫do das instru√ß√µes (primeiros 100 caracteres):", systemInstructionContent.substring(0, 100) + "...");
                isChatReady = true;

                if (chatMessagesDiv) {
                     addMessageToChat(NOME_DA_ASSISTENTE, saudacaoInicialKASI, false);
                     clientChatHistory.push({ role: "model", parts: [{ text: saudacaoInicialKASI }] });
                }
                if (sendButton) sendButton.disabled = false;
                if (userInput) userInput.disabled = false;
                if (userInput) userInput.focus();

            } catch (error) {
                console.error("Falha ao carregar instru√ß√µes da IA:", error);
                addMessageToChat(NOME_DA_ASSISTENTE, `Desculpe, n√£o consegui carregar minhas configura√ß√µes iniciais. Por favor, verifique se o arquivo '${ARQUIVO_INSTRUCOES}' existe na mesma pasta do 'chatbot.html' e tente recarregar a p√°gina.`, false);
                isChatReady = false;
                if (sendButton) sendButton.disabled = true;
                if (userInput) userInput.disabled = true;
            }
        }

        async function sendMessageToAI() {
            if (!isChatReady) {
                addMessageToChat(NOME_DA_ASSISTENTE, "Ainda estou inicializando. Por favor, aguarde um momento.", false);
                return;
            }
            const messageText = userInput.value.trim();
            if (messageText === "") return;

            addMessageToChat("Voc√™", messageText, true);
            clientChatHistory.push({ role: "user", parts: [{ text: messageText }] });

            userInput.value = "";
            sendButton.disabled = true;
            userInput.disabled = true;
            showLoadingIndicator();

            try {
                const API_GATEWAY_INVOKE_URL = 'https://teste-api-kah.jorge-acc2004.workers.dev/';

                const response = await fetch(API_GATEWAY_INVOKE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: messageText,
                        history: clientChatHistory.slice(0, -1),
                        systemInstruction: systemInstructionContent
                    })
                });

                const responseBodyText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseBodyText);
                } catch (e) {
                    console.error("Resposta do servidor n√£o √© JSON v√°lido:", responseBodyText);
                    addMessageToChat(NOME_DA_ASSISTENTE, "Desculpe, recebi uma resposta inesperada do servidor.", false);
                    return;
                }

                if (!response.ok || data.error) {
                    console.error("Erro retornado pelo backend:", data.error || `Status: ${response.status}`);
                    let displayError = data.error || `Erro ${response.status} ao contatar o servidor. Tente novamente.`;
                    addMessageToChat(NOME_DA_ASSISTENTE, displayError, false);
                    return;
                }

                const aiText = data.aiResponse;

                hideLoadingIndicator();
                addMessageToChat(NOME_DA_ASSISTENTE, aiText, false);
                clientChatHistory.push({ role: "model", parts: [{ text: aiText }] });

            } catch (error) {
                console.error("Erro de rede ou ao chamar a API do Chatbot:", error);
                addMessageToChat(NOME_DA_ASSISTENTE, `Desculpe, tive um problema de comunica√ß√£o. Por favor, verifique sua conex√£o e tente novamente. (${error.message})`, false);
            } finally {
                hideLoadingIndicator();
                if (isChatReady) {
                    sendButton.disabled = false;
                    if (userInput) userInput.disabled = false;
                    if (userInput) userInput.focus();
                }
            }
        }

        if (sendButton) sendButton.addEventListener('click', sendMessageToAI);
        if (userInput) {
            userInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !sendButton.disabled && isChatReady) {
                    sendMessageToAI();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (sendButton) sendButton.disabled = true;
            if (userInput) userInput.disabled = true;
            addMessageToChat(NOME_DA_ASSISTENTE, "Ol√°! Estou me preparando para te ajudar...", false);
            carregarInstrucoes();
        });

    </script>
</body>
</html>
